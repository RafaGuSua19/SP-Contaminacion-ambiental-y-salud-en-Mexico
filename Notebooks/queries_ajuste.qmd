---
title: "queries ajuste"
format: html
editor: visual
---

```{r}
library(bnlearn)
library(tidyverse)
```

```{r}
data = read_csv("../Notebooks/data_final5.csv")
head(data)
```

## Selección y limpieza de variables para el DAG

```{r}
# Nombres de variables del DAG
variables_dag <- c("municipio", "edad", "hemoglobina", "acido_urico",
  "colesterol_total", "creatinina", "glucosa", "insulina", "proteina_cr", 
  "trigliceridos", "hemoglobina_glucosilada", "folato", "homocistenia", 
  "vit_b12", "vit_d", "SO_2", "CO", "NOx", "PM_010", "PM_2_5"
)

# Filtra solo las columnas necesarias
data_dag <- data[, variables_dag]

# Variables discretas (factor)
discretas <- c("municipio")
for (v in discretas) {
 if (v %in% names(data)) data[[v]] <- as.factor(data_dag[[v]])
}

# Variables categóricas a numéricas
data_dag$municipio <- as.numeric(data$municipio)

head(data_dag)
```

## Definición de la estructura del DAG (la red)

```{r}
propuesta <- "[edad][municipio][glucosa|edad][insulina|edad][CO|municipio][NOx|municipio][PM_010|municipio][PM_2_5|municipio][SO_2|municipio][acido_urico|municipio:edad][colesterol_total|municipio:edad][folato|municipio][trigliceridos|municipio:edad][vit_b12|municipio][vit_d|municipio:edad][hemoglobina|CO][creatinina|CO:edad][homocistenia|NOx:SO_2][proteina_cr|PM_010:PM_2_5:homocistenia][hemoglobina_glucosilada|glucosa:insulina:proteina_cr]"

dag <- model2network(propuesta)
nodes(dag)
```

## Visualiza la estructura del DAG

```{r}
graphviz.plot(dag, shape = "ellipse")
```

```{r}
fit_m <- bn.fit(dag, data_dag)
```


```{r}
set.seed(1234)
```

## Consulta 1 · Proteína C Reactiva vs PM2.5
**Pregunta.** ¿Cuál es la probabilidad de que una persona tenga **proteína C reactiva > 10 mg/L** dado que la concentración de **PM₂.₅ <= 155 μg/m³**?


$$
\mathbb{P}\!\left(\text{proteina_cr}>0.001 \;\middle|\; PM_{2.5}<=155\ \mu\mathrm{g/m}^3\right)
$$

```{r}
cpquery(fit_m, event = (proteina_cr > 0.001), evidence = ( PM_2_5 <= 155), n = 10^6)
```

---

## Consulta 2 · Glucosa y contaminante del aire
**Pregunta.** ¿Cuál es la probabilidad de que una persona tenga **glucosa en ayuno > 126 mg/dL** dado que es **mayor o igual a 50 años** y está expuesta a **NOx >= 40 ppb**?

$$
\mathbb{P}\!\left(\mathrm{glucosa}>126\ \text{mg/dL}\ \middle|\ \mathrm{edad}\geq 50,\ NOx>=40\ \text{ppb}\right)
$$

```{r}
cpquery(fit_m, event = (glucosa > 126), evidence = ( edad >= 50 & NOx >= 40 ), n = 10^6)
```


---

## Consulta 3 · Colesterol total y SO₂
**Pregunta.** ¿Cuál es la probabilidad de que una persona tenga **colesterol total > 130 mg/dL** dado un nivel de **SO₂ >= 80 ppb**?

$$
\mathbb{P}\!\left(\mathrm{colesterol\_total}>130\ \text{mg/dL}\ \middle|\ SO_2>=80\ \text{ppb}\right)
$$

```{r}
cpquery(fit_m, event = (colesterol_total > 130), evidence = ( SO_2 >= 80), n = 10^6)
```

